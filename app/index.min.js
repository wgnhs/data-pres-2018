!(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("lit-element"),require("wgnhs-common"),require("wgnhs-router"),require("wgnhs-styles"),require("wgnhs-pdf"),require("wgnhs-layout")):"function"==typeof define&&define.amd?define(["exports","lit-element","wgnhs-common","wgnhs-router","wgnhs-styles","wgnhs-pdf","wgnhs-layout"],e):e((t=t||self).app={},t["wgnhs-common"],t["wgnhs-common"],t["wgnhs-router"],t["wgnhs-common"],t["wgnhs-pdf"],t["wgnhs-layout"])})(this,function(t,e,i,o,s,r,n){"use strict";class l{constructor(t){Object.assign(this,t),this.id||(this.id=i.genId())}activate(t){let e=null;const i=t.detail.checked;return t.toggleable&&i&&(e={id:t.id,context:t,resolve:function(e){return e[t.prop]===t.value}}),e}}class a{constructor(){this.id=i.genId()}get next(){return e.html`<input type=checkbox>`}handle(t){let e=null;return t.target.nextElementSibling.checked&&(e={id:t.id,context:t,resolveGroup:function(e){return!t.group.prop||t.group[t.group.prop]===e[t.group.prop]},resolve:function(e){return!!e[t.prop]}}),e}}class c{constructor(t){this.id=i.genId(),this.gtName=t?"after":"at least",this.eqName=t?"exactly":"equal to",this.ltName=t?"before":"less than"}get next(){return e.html`<select><option value=gt>${this.gtName}</option><option value=eq>${this.eqName}</option><option value=lt>${this.ltName}</option></select> <input type=text>`}handle(t){let e=null;t.gt=((t,e)=>t>=e),t.eq=((t,e)=>t==e),t.lt=((t,e)=>t<e);const i=t[t.target.nextElementSibling.value],o=t.target.nextElementSibling.nextElementSibling.value;return o&&(e={id:t.id,context:t,resolveGroup:function(e){return!t.group.prop||t.group[t.group.prop]===e[t.group.prop]},resolve:function(e){let s=!!e[t.prop];return s&&(s=i(e[t.prop],o)),s}}),e}}class d{constructor(){this.id=i.genId()}get next(){return e.html`<select ?disabled=${!this.options}><option></option>${this.options?this.options.map(t=>e.html`<option value=${t}>${t}</option>`):""}</select>`}init(t){this.options||(this.options=Array.from(t).sort())}handle(t){let e=null;const i=t.target.nextElementSibling.value;return i&&(e={id:t.id,context:t,resolveGroup:function(e){return!t.group.prop||t.group[t.group.prop]===e[t.group.prop]},resolve:function(e){let o=!!e[t.prop];if(o){o=e[t.prop]===i}return o}}),e}}class u{constructor(t){this._aggrKeys=["County","Drill_Method","Project"],this.aggrData=[];for(let e of t)this.aggrData.push(u._gatherAggrData(e,this._aggrKeys));this.datas=this.aggrData.map(t=>t.data).reduce((t,e)=>t.concat(e),[]),this.uniques={},this._aggrKeys.forEach(t=>this.uniques[t]=new Set(this.datas.map(e=>e[t]).filter(t=>!!t)))}static _gatherAggrData(t,e){const i={aggr:{},data:[]};return t.eachLayer(function(t,o){let s={};e.forEach(function(e){s[e]=t.feature.properties[e],i.aggr[e]||(i.aggr[e]={});let o=i.aggr[e];s[e]&&"number"==typeof s[e]&&((!o.max||o.max<s[e])&&(o.max=s[e]),(!o.min||o.min>s[e])&&(o.min=s[e]))}),i.data.push(s)}),i}}const p=["Site_Code","Data_Type","SiteName","Site_Name","Wid","ID","County"],h={Site_Name:{title:"Name",desc:""},Wid:{title:"WGNHS ID",desc:""},WID:{title:"WGNHS ID",desc:""},RecentLog:{title:"Most recent log (year)",desc:""},MaxDepth:{title:"Max depth (ft)",desc:""},Norm_Res:{title:"Normal Resistivity",desc:""},Caliper:{title:"Caliper",desc:""},Gamma:{title:"Natural Gamma",desc:""},SP:{title:"Spontaneous (Self) Potential",desc:""},SPR:{title:"Single Point Resistivity",desc:""},Spec_Gamma:{title:"Spectral Gamma",desc:""},Fluid_Cond:{title:"Fluid Conductivity",desc:""},Flow_Spin:{title:"Spinner Flow Meter",desc:""},Flow_HP:{title:"HeatPulse Flow Meter",desc:""},Fluid_Temp:{title:"Fluid Temperature",desc:""},Fluid_Res:{title:"Fluid Resistivity",desc:""},OBI:{title:"Optical Borehole Image (OBI)",desc:""},ABI:{title:"Acoustic Borehole Image (ABI)",desc:""},Video:{title:"Video",desc:""},Field_ID:{title:"Field ID",desc:""},Project:{title:"Project",desc:""},Drill_Year:{title:"Drill year",desc:""},Depth_Ft:{title:"Depth (ft)",desc:""},Drill_Method:{title:"Drill Method",desc:""},Subsamples:{title:"Subsamples",desc:""},Photos:{title:"Core Photos",desc:""},Grainsize:{title:"Grainsize",desc:""},Age_Data:{title:"Age data",desc:""},Proxy_Data:{title:"Proxy data",desc:""}},g=[new l({title:"Site information",open:!0,sections:[{fields:{County:{controls:[new d]},Site_Name:{controls:[new class{constructor(){this.id=i.genId()}get next(){return e.html`<input type=text>`}handle(t){let e=null;const i=(""+t.target.nextElementSibling.value).trim().toUpperCase();return i&&(e={id:t.id,context:t,resolveGroup:function(e){return!t.group.prop||t.group[t.group.prop]===e[t.group.prop]},resolve:function(e){let o=!!e[t.prop];return o&&(o=(""+e[t.prop]).trim().toUpperCase().includes(i)),o}}),e}}]},Wid:{controls:[new class{constructor(){this.id=i.genId()}get next(){return e.html`<input type=text>`}handle(t){let e=null;const i=(""+t.target.nextElementSibling.value).trim().toUpperCase();return i&&(e={id:t.id,context:t,resolveGroup:function(e){return!t.group.prop||t.group[t.group.prop]===e[t.group.prop]},resolve:function(e){let o=!!e[t.prop];return o&&(o=(""+e[t.prop]).trim().toUpperCase()===i),o}}),e}}]}}}]}),new l({title:"Geophysical Log data",prop:"Data_Type",Data_Type:"geophysical log",source:{geojson:"https://data.wgnhs.wisc.edu/arcgis/rest/services/geologic_data/borehole_geophysics/MapServer/0/query?where=1%3D1&inSR=4326&outFields=*&returnGeometry=true&geometryPrecision=6&outSR=4326&f=geojson",user:"https://data.wgnhs.wisc.edu/arcgis/rest/services/geologic_data/borehole_geophysics/MapServer/0"},color:"var(--map-symbol-0)",toggleable:!0,active:!0,sections:[{fields:{RecentLog:{controls:[new c(!0)]},MaxDepth:{controls:[new c]}}},{title:"Geologic",bundled:!0,fields:{Norm_Res:{controls:[new a]},Caliper:{controls:[new a]},Gamma:{controls:[new a]},SP:{controls:[new a]},SPR:{controls:[new a]},Spec_Gamma:{controls:[new a]}}},{title:"Hydrogeologic",bundled:!0,fields:{Fluid_Cond:{controls:[new a]},Flow_Spin:{controls:[new a]},Fluid_Temp:{controls:[new a]},Fluid_Res:{controls:[new a]},Flow_HP:{controls:[new a]}}},{title:"Image",bundled:!0,fields:{OBI:{controls:[new a]},ABI:{controls:[new a]},Video:{controls:[new a]}}}]}),new l({title:"Quaternary Core data",prop:"Data_Type",Data_Type:"quaternary core",source:{geojson:"https://data.wgnhs.wisc.edu/arcgis/rest/services/geologic_data/sediment_core/MapServer/0/query?where=1%3D1&inSR=4326&outFields=*&returnGeometry=true&geometryPrecision=6&outSR=4326&f=geojson",user:"https://data.wgnhs.wisc.edu/arcgis/rest/services/geologic_data/sediment_core/MapServer/0"},color:"var(--map-symbol-1)",toggleable:!0,active:!0,sections:[{fields:{Drill_Year:{controls:[new c(!0)]},Project:{controls:[new d]},Depth_Ft:{controls:[new c]},Drill_Method:{controls:[new d]}}},{title:"Analyses available",bundled:!0,fields:{Subsamples:{controls:[new a]},Photos:{controls:[new a]},Grainsize:{controls:[new a]},Age_Data:{controls:[new a]}}}]})],m=L.CircleMarker.extend({getEvents:function(){return{zoomend:this._restyle,filterpoints:this._filter}},_restyle:function(t){this.setRadius(m.calcRadius(t.target.getZoom()))},_filter:function(t){t.detail.resolve(this.feature.properties)?this.setStyle({stroke:!0,fill:!0}):this.setStyle({stroke:!1,fill:!1})},highlight:function(){this._activeBackup={color:this.options.color,stroke:this.options.stroke,fill:this.options.fill},this.setStyle({color:"var(--map-symbol-active)",stroke:!0,fill:!0})},removeHighlight:function(){this._activeBackup&&(this.setStyle(this._activeBackup),this._activeBackup=null)}});m.calcRadius=(t=>Math.max(Math.floor(t/1.5),3));class f extends window.L.Evented{constructor(){super(),this.selected=!1,this._highlight=null,this.map=L.map("map",{zoomControl:!1}).setView([44.25,-89.9],7),this.el=document.querySelector("#map"),new L.Control.Zoom({position:"topright"}).addTo(this.map);var t=[L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>',label:"CARTO Voyager"}),L.esri.basemapLayer("Imagery",{label:"Esri Satellite"})];t[0].addTo(this.map),this.map.addControl(L.control.basemaps({basemaps:t,tileX:0,tileY:0,tileZ:1})),this.sources=g.reduce((t,e)=>(e.source&&e.source.geojson&&t.push(window.fetch(e.source.geojson,{cache:"no-store"}).then(t=>t.json(),t=>{console.log(t)}).then(t=>({name:e[e.prop],color:e.color,data:t}),t=>{console.log(t)})),t),[])}init(){const t=this.map;return Promise.all(this.sources).then(e=>{this.layers=e.map(e=>L.geoJSON(e.data,{name:e.name,pointToLayer:function(i,o){return new m(o,{weight:2,color:e.color,radius:m.calcRadius(t.getZoom()),stroke:!1,fill:!1})}})),this.layers.forEach(t=>t.on("click",t=>{this._highlight!==t.propagatedFrom?this.fire("interaction",t.propagatedFrom.feature.properties):this.fire("interaction")})),this.layers.forEach(t=>t.addTo(this.map));let i={};this.layers.forEach(function(t,e,o){t.eachLayer(function(s){let r=s.feature.properties.Wid||s.feature.properties.WGNHS_ID,n=f.getSiteCode(s.feature.properties),l=s.feature.properties.Site_Name||s.feature.properties.SiteName,a=s.getLatLng(),c=i[n]||{Site_Code:n,Site_Name:l,Wid:r,Latitude:a.lat.toFixed(6),Longitude:a.lng.toFixed(6),point:s,datas:new Array(o.length)};s.feature.properties.Site_Code=n,s.feature.properties.Site_Name=l,s.feature.properties.Data_Type=t.options.name,c.datas[e]=s.feature.properties,i[n]=c})}),this._lookup=i},t=>console.log(t))}static getSiteCode(t){return["Wid","WGNHS_ID","ID","Site_Code"].reduce((e,i)=>e||t[i],void 0)}getPoint(t){let e=null,i=this._lookup[f.getSiteCode(t)];return i&&(e=i.point),e}getSite(t){return this._lookup[f.getSiteCode(t)]}zoomToPoint(t){let e=this.getPoint(t);e&&this.map.setZoomAround(e.getLatLng(),15)}getHighlightPoint(){return this._highlight}setHighlightPoint(t){t?(this._highlight=t,this._highlight.bringToFront(),this._highlight.highlight()):this.clearSelection()}selectPoint(t){let e=null,i=this.getPoint(t);if(i){e=i.feature.properties,i!==this.getHighlightPoint()&&(this.clearSelection(),this.setHighlightPoint(i))}return e}selectSite(t){let e=this.getSite(t);return this.selectPoint(t),e}clearSelection(){this._highlight&&(this._highlight.bringToBack(),this._highlight.removeHighlight()),this._highlight=null}updatePoints(t){this.map.fire("filterpoints",{detail:{resolve:e=>t.reduce((t,i)=>{const o=f.getSiteCode(e),s=i.has(""+o);return t||s},!1)}})}setVisibility(t){t?(this.el.removeAttribute("data-closed"),this.map.invalidateSize()):this.el.setAttribute("data-closed",!0)}}class w extends e.LitElement{static get layoutName(){}static include(t,i){return e.html`<table-layout .info=${t} .context=${i}></table-layout>`}static get properties(){return{info:{type:Object},context:{type:Object}}}constructor(){super(),this.genId=(function(){const t={};return function(e){return t[e]||(t[e]=i.genId()),t[e]}})()}static get styles(){return e.css`[data-element=table]{display:grid;grid-template-columns:40% 1fr;grid-gap:var(--border-radius);margin:0 var(--border-radius)}.label{font-weight:var(--font-weight-bold)}`}render(){return e.html`<dl data-element=table>${Object.entries(this.info).filter(t=>!p.includes(t[0])).filter(t=>!!t[1]).map((t,i)=>e.html`<dt class=label title=${h[t[0]]?h[t[0]].desc:t[0]}><label for=${this.genId(i)}>${h[t[0]]?h[t[0]].title:t[0]}</label></dt><dd class=detail title=${h[t[0]]?h[t[0]].desc:t[0]}><span id=${this.genId(i)}>${t[1]}</span></dd>`)}</dl>`}}customElements.define("table-layout",w);const y=function(t,e,i,o,s){return(e=Math,i=e.log,o=1024,s=i(t)/i(o)|0,t/e.pow(o,s)).toFixed(2)+" "+(s?"KMGTPEZY"[--s]+"iB":"Bytes")};customElements.define("download-button",class extends e.LitElement{static get properties(){return{src:{type:String},exists:{type:Boolean,reflect:!0},fileSize:{type:String,attribute:!1}}}constructor(){super()}static get styles(){return[...i.styles,e.css`[data-closed]{display:none}.file-size{font-size:var(--font-size-small)}`]}render(){return e.html`<button-link href=${this.src} target=_blank download><i slot=content-before class=material-icons title=Download>save_alt</i> <span slot=content><slot name=label>Download</slot></span><span slot=content-after class=file-size><slot name=detail>${this.fileSize}</slot></span></button-link>`}updated(t){t.has("src")&&this.src&&(this.exists=!1,window.fetch(this.src,{method:"HEAD",cache:"no-store"}).then(t=>{if(t.ok){this.exists=!0;let e=t.headers.get("Content-Length");e&&(this.fileSize=y(e))}}))}});const b="toggle-pdf-panel";customElements.define("pdf-split-button",class extends e.LitElement{static get properties(){return{src:{type:String},panel:{type:Object,attribute:!1},closed:{type:Boolean,attribute:!1}}}constructor(){super(),this.closed=!0}static get styles(){return[...s.styles,e.css`.container{display:grid;grid-template-columns:1fr 1fr;grid-gap:var(--border-radius)}.dl-button:not([exists]),.dl-button:not([exists])+.view-button{visibility:hidden}`]}render(){return e.html`<div class=container><download-button class=dl-button src=${this.src}><span slot=label><slot name=download-text>Download</slot></span><span slot=detail></span></download-button><app-collapsible class=view-button @open=${this.toggle} button><span slot=header><slot name=view-text>View</slot></span><i slot=header-after class=material-icons title=View>${this.alt?"chevron_left":"chevron_right"}</i></app-collapsible></div>`}updated(t){(t.has("panel")||t.has("src"))&&this.panel&&this.src&&this.panel.request(this.src)}toggle(t){this.closed?this.panel.show(this.src):this.panel.hide()}handleAlt(t){t.detail.url===this.src?this.closed=!1:this.closed=!0,this.requestUpdate()}connectedCallback(){super.connectedCallback(),this.__altHandler=this.handleAlt.bind(this),document.addEventListener(b,this.__altHandler)}disconnectedCallback(){document.removeEventListener(b,this.__altHandler),super.disconnectedCallback()}});class v extends e.LitElement{static get layoutName(){return"geophysical log"}static include(t,i){return e.html`<log-layout .info=${t} .context=${i}></log-layout>`}static get properties(){return{info:{type:Object},context:{type:Object}}}constructor(){super()}static get styles(){return e.css`.dl-las:not([exists]){visibility:hidden}`}render(){return e.html`<table-layout .info=${this.prepInfo()} .context=${this.context}></table-layout><pdf-split-button .panel=${this.context.pdfpanel} src=${"https://data.wgnhs.wisc.edu/borehole-geophysics/pdf/"+this.info.Wid+".pdf"}><span slot=download-text>Download PDF</span></pdf-split-button><download-button class=dl-las src=${"https://data.wgnhs.wisc.edu/borehole-geophysics/las/"+this.info.Wid+".las"}><span slot=label>Download LAS</span></download-button>`}prepInfo(){return Object.assign(this.topFields,this.bottomFields)}get topFields(){return this.getFields(t=>!t.bundled)}get bottomFields(){const t=this.getFields(t=>t.bundled);return{"Data available:":Object.entries(t).filter(t=>!!t[1]).map(t=>h[t[0]]?h[t[0]].title:t[0]).map(t=>e.html`${t}<br>`)}}get group(){return g.find(t=>t.prop&&t[t.prop]===this.info[t.prop])}getFields(t){const e={};return this.group.sections.filter(t).forEach(t=>{Object.entries(t.fields).forEach(t=>{e[t[0]]=this.info[t[0]]})}),e}}customElements.define("log-layout",v);class _ extends e.LitElement{static get layoutName(){return"quaternary core"}static include(t,i){return e.html`<core-layout .info=${t} .context=${i}></core-layout>`}static get properties(){return{info:{type:Object},context:{type:Object}}}constructor(){super()}static get styles(){return e.css``}render(){return e.html`<table-layout .info=${this.prepInfo()}></table-layout>`}prepInfo(){return Object.assign(this.topFields,this.bottomFields)}get topFields(){return this.getFields(t=>!t.bundled)}get bottomFields(){const t=this.getFields(t=>t.bundled);let i=Object.entries(t).filter(t=>!!t[1]).map(t=>h[t[0]]?h[t[0]].title:t[0]).map(t=>e.html`${t}<br>`);return i.length<1&&(i=null),{"Analyses available:":i}}get group(){return g.find(t=>t.prop&&t[t.prop]===this.info[t.prop])}getFields(t){const e={};return this.group.sections.filter(t).forEach(t=>{Object.entries(t.fields).forEach(t=>{e[t[0]]=this.info[t[0]]})}),e}}customElements.define("core-layout",_);const S=w,x=[S,v,_],$={getLayout:function(t){let e=x.find(e=>e.layoutName===t);return e||(e=S),e.include}};class E extends e.LitElement{static get properties(){return{siteinfo:{type:Object},pdfpanel:{type:Object}}}constructor(){super()}static get styles(){return[...s.styles,e.css`.header{position:-webkit-sticky;position:sticky;top:0;background-color:var(--palette-white);padding:var(--font-size-extra-large) var(--border-radius);z-index:10;width:100%;box-sizing:border-box;display:flex;justify-content:space-between}.header h1{padding:0;max-width:70%;text-align:center}.header i{font-size:var(--icon-size-large);color:var(--palette-accent);cursor:pointer}.name{text-transform:capitalize}[data-closed]{display:none}`]}renderData(t,e){return $.getLayout(e)(t,this)}render(){let t=this.siteinfo?this.siteinfo.Latitude:null,i=this.siteinfo?this.siteinfo.Longitude:null,o=this.siteinfo?this.siteinfo.Wid:null;return e.html`${this.siteinfo?e.html`<div class=header><span><a href=${window.router.link("entry")} onclick=event.preventDefault()><i class="material-icons clear-selection" title="Clear selection" @click=${this.fireClearSelection}>arrow_back</i></a></span><h1>${this.siteinfo.Site_Name}</h1><span><i class="material-icons zoom-to-site" title="Zoom to site" @click=${this.fireZoomToSite}>my_location</i></span></div>${this.renderData({Latitude:t,Longitude:i,WID:o})} ${this.siteinfo.datas.map(t=>e.html`<app-collapsible open><span slot=header class=name>${t.Data_Type}</span><div slot=content>${this.renderData(t,t.Data_Type)}</div></app-collapsible>`)}`:""}`}fireClearSelection(){i.dispatch(this,"clear-selection",{},!0,!0)}fireZoomToSite(){i.dispatch(this,"zoom-to-site",{params:this.siteinfo},!0,!0)}}customElements.define("site-details",E);customElements.define("filter-summary",class extends e.LitElement{static get properties(){return{counts:{type:Array,attribute:!1}}}constructor(){super()}static get styles(){return e.css`li[disabled]{color:var(--palette-dark)}.name{text-transform:capitalize}`}render(){return this.counts?e.html`<div><span>Showing ${this.counts.reduce((t,e)=>e.current+t,0)} of ${this.counts.reduce((t,e)=>e.total+t,0)} total sites</span><ul>${this.counts.map(t=>e.html`<li ?disabled=${!t.included}>${t.current} of ${t.total} <span class=name>${t.name}</span> sites ${t.filteredBy.length>0?e.html`(filtered by ${t.filteredBy.join(", ")})`:""}</li>`)}</ul></div>`:e.html``}handleFiltered(t){t.detail&&(this.counts=t.detail.counts)}connectedCallback(){super.connectedCallback(),this.__filteredHandler=this.handleFiltered.bind(this),document.addEventListener("filtered",this.__filteredHandler)}disconnectedCallback(){document.removeEventListener("filtered",this.__filteredHandler),super.disconnectedCallback()}});class C extends e.LitElement{static get properties(){return{include:{type:Array,attribute:!1},filter:{type:Array,attribute:!1},matchClass:{type:String,attribute:!1},sources:{type:Array,attribute:!1}}}static get styles(){return[...s.styles,e.css`
      .field {
        display: grid;
        grid-template-columns: 40% 1fr;
        grid-gap: var(--border-radius);
        margin: 0 var(--border-radius);
      }

      .label {
        font-weight: var(--font-weight-bold);
      }

      .selector {
      }

      .section-title {
        margin: var(--line-height) 0 0 0;
        padding: var(--border-radius);
        background-color: var(--palette-light);
      }

      in-radio {
        display: inline-grid;
        grid-template-columns: auto auto;
      }
    `]}updateMatchClass(t){this.matchClass=t.target.choice}render(){return e.html`
      <div>
        Show sites that have <in-radio choices='["ALL", "ANY"]' @choice-change="${this.updateMatchClass}"></in-radio> of the following:
      </div>
      <div>
        ${this.renderFilterGroups()}
      </div>
    `}resolveKeyLookup(t){return h[t]?h[t].title:t}renderFilterGroups(){return this.filterGroups.map(t=>e.html`
      <app-collapsible
        ?open=${t.open} @open=${this._handle(t)}>
        <i slot="header-before" class="material-icons">expand_more</i>
        <span slot="header">${t.title}</span>
        ${t.toggleable?e.html`
          <toggle-switch
            name="${t.title}"
            slot="header-after"
            ?checked=${t.active}
            @change=${this._handleGroup(t,"include")}
            style="--palette-active: ${t.color}"
          ></toggle-switch>
        `:""}
        <div slot="content">
          ${t.sections.map((i,o)=>e.html`
            ${i.title?e.html`
              <h2 class="section-title">${i.title}</h2>
            `:""}
            ${Object.entries(i.fields).map((i,o)=>e.html`
              <div class="field">
              ${0===i[1].controls.length?"":i[1].controls.map(s=>e.html`
                <td class="label">
                  <label for="${this.genId(o)}" >
                    ${this.resolveKeyLookup(i[0])}
                  </label>
                </td>
                <td class="selector" 
                    @change="${this._handleControl(t,s,"filter")}">
                  <input
                    type="hidden"
                    id="${s.id}"
                    name="${i[0]}">
                  ${s.next}
                </td>
              `)}
              </div>
            `)}
          `)}
        </div>
      </app-collapsible>
    `)}get _eventHandlers(){return{open:(t,e)=>{t.open=e.detail.value}}}_handle(t){return e=>{const i=this._eventHandlers[e.type];i&&(i(t,e),this.requestUpdate("handle_"+e.type))}}_handleGroup(t,e){const i=t.id,o=t.activate.bind(t),s=this[e],r=this.requestUpdate.bind(this);return n=>{const l={};l.id=i,l.toggleable=t.toggleable,l.detail=n.detail,l.prop=t.prop,l.value=t[t.prop],D(s,i);let a=o(l);a&&s.push(a),r(e)}}_handleControl(t,e,i){const o=e.id,s=e.handle.bind(e),r=this[i],n=this.requestUpdate.bind(this);return e=>{const l={};l.id=o,l.group=t,l.target=e.currentTarget.querySelector("#"+o),l.prop=l.target.name,D(r,o);let a=s(l);a&&r.push(a),n(i)}}updated(t){const e=t.has("matchClass")||t.has("include")||t.has("filter")||t.has("sources");if(this.sources&&e){const t=C.runFilter({matchClass:this.matchClass,incl:this.include,filt:this.filter,sources:this.sources}),e=C.getResultsInfo(this.matchClass,this.include,this.filter,this.sources,t);i.dispatch(this,"filtered",{activePoints:t,counts:e},!0,!0)}}init(t,e){this.filterGroups.forEach(e=>{e.sections.forEach(e=>{Object.entries(e.fields).forEach(e=>{e[1].controls.forEach(i=>{i.init&&i.init(t[e[0]])})})})}),this.sources=e}static runFilter({matchClass:t,incl:e,filt:i,sources:o}){return o.map(o=>{const s=new Set;return Object.entries(o._layers).forEach(o=>{(function(o){let s=e.length>0&&e.reduce((t,e)=>t||e.resolve(o),!1),r=i.filter(t=>t.resolveGroup(o)),n=s&&r.length<1;return s&&!n&&(n="ALL"===t?r.reduce((t,e)=>t&&e.resolve(o),!0):r.reduce((t,e)=>t||e.resolve(o),!1)),n})(o[1].feature.properties)&&s.add(""+f.getSiteCode(o[1].feature.properties))}),s})}static getResultsInfo(t,e,i,o,s){return o.map((o,r)=>{let n={};n.name=o.options.name,n.included=e.some(t=>t.context.value===o.options.name),n.filteredBy=i.reduce((t,e)=>(e.context.group[e.context.group.prop]===o.options.name&&t.push(h[e.context.prop]?h[e.context.prop].title:e.context.prop),t),[]),n.matchClass=t;let l=Object.entries(o._layers);return n.total=l.length,n.current=s[r].size,n})}constructor(){super(),this.genId=(function(){const t={};return function(e){return t[e]||(t[e]=i.genId()),t[e]}})(),this.include=[],this.filter=[],this.filterGroups=g}}customElements.define("map-filter",C);const D=(t,e)=>{for(var i=t.findIndex(t=>t.id===e);i>=0;i=t.findIndex(t=>t.id===e))t.splice(i,1)};window.siteMap=new f,window.sidebar=document.querySelector("#sidebar"),window.pdfPanel=document.querySelector("#sketch"),document.querySelectorAll("site-details").forEach(function(t){t.pdfpanel=window.pdfPanel}),window.filter=document.querySelector("#filter"),window.siteMap.init().then(function(){window.siteData=new u(window.siteMap.layers),window.aggrData=siteData.aggrData,filter.init(window.siteData.uniques,window.siteMap.layers);var t=function(){window.pdfPanel.hide(),document.querySelectorAll("site-details").forEach(function(t){t.siteinfo=null})};async function e(e){return t(),document.querySelectorAll("site-details").forEach(function(t){t.siteinfo=e}),!0}window.router=new o.SiteRouter,window.router.addRoute({name:"entry",url:"/",onEnter:function(e,i){window.siteMap.clearSelection(),t(),document.querySelector("#app").setAttribute("data-view","app"),window.sidebar.switchTab("default"),window.siteMap.setVisibility(!0)},onExit:function(t,e){}}),window.router.addRoute({name:"view",url:"/view/:Site_Code",onEnter:function(t,i){let o=t.params(),s=window.siteMap.selectSite(o);s?(document.querySelectorAll("site-details").forEach(function(t){t.printLayout=!1}),e(s).then(()=>{document.querySelector("#app").setAttribute("data-view","app"),window.sidebar.switchTab("details"),window.siteMap.setVisibility(!0)})):window.router.clearRoute()},onExit:function(t,e){}}),window.router.addRoute({name:"print",url:"/print/:Site_Code",onEnter:function(t,i){let o=t.params(),s=window.siteMap.selectSite(o);s?(document.querySelectorAll("site-details").forEach(function(t){t.printLayout=!0}),e(s).then(()=>{document.querySelector("#app").removeAttribute("data-view"),window.sidebar.switchTab("details"),window.siteMap.setVisibility(!1)})):window.router.clearRoute()},onExit:function(t,e){}}),window.router.router.transitionService.onEnter({},()=>{document.querySelector("#spinner").setAttribute("data-closed",!0)}),window.router.start(),window.siteMap.on("interaction",t=>{t.Site_Code?window.router.setRoute("view",t):window.router.clearRoute()})}),document.addEventListener("clear-selection",function(t){window.router.clearRoute()}),document.addEventListener("zoom-to-site",function(t){window.siteMap.zoomToPoint(t.detail.params)}),document.addEventListener("toggle-print",function(t){t.detail.on?window.router.setRoute("print",t.detail.params):window.router.setRoute("view",t.detail.params)}),document.addEventListener("toggle-pdf-panel",function(t){window.siteMap.setVisibility(t.detail.closed),t.detail.closed?window.pdfPanel.setAttribute("data-closed",!0):window.pdfPanel.removeAttribute("data-closed")}),document.addEventListener("filtered",function(t){window.siteMap.updatePoints(t.detail.activePoints)}),t.MapFilter=C,t.SiteDetails=E,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=index.min.js.map
